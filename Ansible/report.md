# Ansible + Terraform

- [Задание](#задание)
- [Теория](#теория)
- [Выполнение задания](#выполнение-задания)
- [Выводы](#выводы)

## Задание: 

Разработать инфраструктуру в облаке Yandex Cloud для запуска виртуального сервера с предустановленным Nginx с помощью инструментов автоматизации:

* Создать и настроить инфраструктуру с помощью Terraform;

* Развернуть и настроить Nginx на созданном сервере с использованием Ansible.

## Теория

![image](https://github.com/user-attachments/assets/0c45a1a1-f1e1-45b7-a24b-aeb4dff3b6a0)

Лень — двигатель прогресса. Людям стало лень подниматься по лестнице, и они придумали лифт. Когда было лень вставать с дивана, чтобы переключить канал на телевизоре — придумали пульт.
А мы в своей уютной айтишке решили избавиться от необходимости повторять одни и те же действия и начали придумывать, как это всё можно автоматизировать. И тут понеслась. Средства реализации
Yandex Cloud

Terraform >= 0.13

Ansible >= 2.9



Представьте: у вас есть десятки или сотни серверов, на которых нужно что-то сделать — обновить конфиги, завести пользователей, сделать бэкапы, перезапустить сервисы или всё сразу. Делать это руками? Раз за разом подключаться по SSH, вводить одни и те же команды? Скучно, долго и опасно: можно ошибиться.
И тут на помощь приходит Ansible — опенсорсный инструмент с классным логотипом, который помогает автоматизировать ИТ-задачи.

Ansible не требует установки агентов на серверы (в отличие от Puppet или Chef). Всё, что нужно — это доступ по SSH и управляющий компьютер с установленным Ansible.

* Основные элементы Ansible:

  * Inventory (инвентори) — файл, где описаны серверы и группы серверов, к которым будем подключаться.

  * Playbook (плейбук) — YAML-файл, где мы описываем задачи, которые хотим выполнить на серверах.

  * Task (таска) — отдельное действие в плейбуке.

  * Module (модуль) — маленькая программка, которая выполняет конкретную задачу (например, установка пакета, запуск контейнера, создание файла).

Ansible выполняет задачи декларативно — мы описываем, что хотим получить, а не как это сделать. Ansible позволяет сосредоточиться на логике, а не на рутинных действиях. Он не спрашивает, какой это по счёту сервер — 20-й или 20 000-й. Он просто выполнит всё, как надо.

[Источник](https://www.youtube.com/watch?v=23Zec3ORJOY&t=4s&ab_channel=MerionAcademy)

## Выполнение задания:

* В качетсве экспериментуемого возьмем сервер, который мы подымали в облаке Yandex Cloud из лаборатроной работы по [Terraform](https://github.com/Georgy-Titov/DevOps/blob/main/Terraform/report.md). Единственное, что мы поправим - уберем следующую строчку в блоке `metadata` ресурса `yandex_compute_instance`:

```
user-data = "${file("init.sh")}"

# Это скрипт, который запускается при инициализации ВМ в облаке.
# В нем мы устанавливали Docker и запускали Nginx в контейнере.
# Но в этой работе мы будем делать все тоже самое, но только при помощи Ansible.
```

* Установим Ansible:

```
sudo apt update
sudo apt install ansible
```

* Далее напишем два файла `intventory.ini` и `playbook.yaml`:

```
# playbook.yaml

- name: Установка и запуск Nginx в Docker через Ansible
  hosts: nginx_server
  become: true

  tasks:
    - name: Обновить список пакетов
      apt:
        update_cache: yes

    - name: Установить docker.io
      apt:
        name: docker.io
        state: present

    - name: Убедиться, что docker запущен и включен в автозагрузку
      systemd:
        name: docker
        state: started
        enabled: yes

    - name: Запустить контейнер Nginx
      docker_container:
        name: nginx-container
        image: nginx
        state: started
        published_ports:  
          - "80:80"

# inventory.ini

 [nginx_server]
<EXTERNAL_IP> ansible_user=ubuntu ansible_ssh_private_key_file=/home/georgy/.ssh/id_rsa

# <EXTERNAL_IP> - подставим ip-адрес, который получим при создании сервера в output "external_ip"
```

* 
